<!DOCTYPE html>
<html>
<head>
    <title>{{ form_title }}</title>
    <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f7f7; }
    .form-box { background: #fff; width: 100vw; max-width: 2200px; margin: 40px auto 0; padding: 32px 48px; border-radius: 10px; box-shadow: 0 2px 8px #eee; }
    .form-row { display: flex; align-items: flex-start; margin-bottom: 18px; max-width: 2000px; }
    .form-label { width: 120px; color: #666; font-size: 15px; margin-right: 12px; }
    .form-input, .form-textarea { font-size: 15px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; }
    .form-textarea { min-height: 80px; font-family: monospace; width: 100%; }
    .form-btn-bar { text-align: right; margin-top: 24px; }
    button, .button { padding: 8px 24px; border-radius: 4px; background: #4f8cff; color: #fff; border: none; margin-left: 8px; font-size: 16px; }
    .row-compact { display: flex; align-items: center; gap: 24px; margin-bottom: 18px; }
    .row-compact .form-label { width: 80px; margin-right: 6px; }
    .row-compact .form-input, .row-compact select { width: 180px; }
    .row { margin: 12px 0; font-size: 16px; }
    .row.flex { display: flex; align-items: center; }
    .row.flex .label { width: 80px; color: #888; }
    .row.flex .value { margin-right: 32px; }
    input, select { width: 100%; padding: 8px; margin: 8px 0 16px; border: 1px solid #ccc; border-radius: 4px; }
    textarea { width: 100%; min-height: 80px; padding: 8px; margin: 8px 0 16px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; }
    button { background: #4f8cff; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; font-size: 16px; margin-left: 0; }
    .add-btn { background: #43c97f; width: auto; margin-left: 0; margin-bottom: 8px; }
    .del-btn { background: #ff4f4f; width: auto; margin-left: 8px; }
    .img-row { display: flex; align-items: center; margin-bottom: 8px; }
    a { display: block; text-align: center; margin-top: 16px; color: #4f8cff; }
    .img-preview { margin: 4px 0 16px; text-align: center; }
    .img-preview img, .pics-list img, .main-img, .big-img, .thumb {
        width: 120px;
        height: 120px;
        object-fit: contain;
        border-radius: 6px;
        border: 1px solid #eee;
        background: #fff;
        display: inline-block;
    }
    .img-preview img[onerror], .pics-list img[onerror], .main-img[onerror], .big-img[onerror], .thumb[onerror] {
        content: '';
        background: #f8d7da url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="120" height="120" fill="%23f8d7da"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="16" fill="%23a94442">加载失败</text></svg>') center center no-repeat;
    }
    </style>
    <script>
    function addPicInput() {
        var div = document.createElement('div');
        div.className = 'img-row';
        div.innerHTML = "<input name='pictures' style='width:80%' placeholder='图片地址'><button type='button' onclick='this.parentNode.remove()' class='del-btn'>删除</button>";
        document.getElementById('pics-list').appendChild(div);
    }
    </script>
</head>
<body>
<form method="post" action="{{ form_action }}">
    <div class="form-box">
        <h2>{{ form_title }}</h2>
        <div class="row-compact">
            <label class="form-label">名称:</label>
            <input class="form-input" type="text" name="name" value="{{ w.name if w else '' }}" required>
            <label class="form-label">类型:</label>
            <input class="form-input" type="text" name="flowType" value="{{ w.flowType if w else '' }}" required>
            <label class="form-label">状态:</label>
            <select name="status" class="form-input">
                <option value="1" {% if w and w.status==1 %}selected{% endif %}>上线</option>
                <option value="0" {% if w and w.status==0 %}selected{% endif %}>下线</option>
            </select>
        </div>
        <div class="form-row">
            <label class="form-label">简介:</label>
            <textarea name="desc" class="form-textarea">{{ w.desc if w else '' }}</textarea>
        </div>
        <div class="form-row">主图: <input name="picture" value="{{ w.picture if w else '' }}" class="form-input"></div>
        <div class="img-preview">{% if w and w.picture %}<img src="{{ w.picture }}" alt="主图">{% endif %}</div>
        <div class="form-row">大图: <input name="bigPicture" value="{{ w.bigPicture if w else '' }}" class="form-input"></div>
        <div class="img-preview">{% if w and w.bigPicture %}<img src="{{ w.bigPicture }}" alt="大图">{% endif %}</div>
        <div class="form-row">
            <label class="form-label">图片组:</label>
            <div id="pics-list" style="display:flex;flex-direction:column;gap:10px;">
                {% if w and w.pictures %}
                    {% for p in w.pictures %}
                    <div class="img-row" style="display:flex;align-items:center;gap:12px;background:#f8fafd;padding:8px 12px;border-radius:6px;">
                        <img src="{{ p }}" alt="图片组" style="width:70px;height:70px;object-fit:contain;border-radius:6px;border:1px solid #eee;background:#fff;">
                        <input name="pictures" value="{{ p }}" style="flex:1;padding:8px 10px;font-size:15px;border-radius:4px;border:1px solid #ccc;" placeholder="图片地址">
                        <button type="button" onclick="this.parentNode.remove()" class="del-btn">删除</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="img-row" style="display:flex;align-items:center;gap:12px;background:#f8fafd;padding:8px 12px;border-radius:6px;">
                        <img src="" alt="图片组" style="width:70px;height:70px;object-fit:contain;border-radius:6px;border:1px solid #eee;background:#fff;">
                        <input name="pictures" style="flex:1;padding:8px 10px;font-size:15px;border-radius:4px;border:1px solid #ccc;" placeholder="图片地址">
                        <button type="button" onclick="this.parentNode.remove()" class="del-btn">删除</button>
                    </div>
                {% endif %}
            </div>
            <button type="button" class="add-btn" onclick="addPicInput()">添加图片</button>
        </div>
        <div class="form-row">
            <label class="form-label">工作流 JSON:</label>
            <textarea name="workflow" class="form-textarea" style="font-family:monospace;">{{ w.workflow if w else '' }}</textarea>
            <div style="font-size:12px;color:#888;">请填写符合 comfyUI/runningHub 的 JSON 工作流定义</div>
        </div>
        <div class="form-row">
            <label for="input_schema" class="form-label">输入参数定义(input_schema)：</label>
            <textarea name="input_schema" placeholder='{"inputs": [{"name": "image", "type": "str", "path": "1.inputs.image"}]}' class="form-textarea">{{ w.input_schema if w and w.input_schema is not none else '' }}</textarea>
        </div>
        <div class="form-row">
            <label for="output_schema" class="form-label">输出参数定义(output_schema)：</label>
            <textarea name="output_schema" placeholder='{"outputs": [{"name": "result", "type": "str", "path": "1.outputs.result"}]}' class="form-textarea">{{ w.output_schema if w and w.output_schema is not none else '' }}</textarea>
        </div>
        <div class="form-row">
            <button type="button" onclick="showPromptParams()" style="background:#43c97f;">自动生成参数定义</button>
            <div id="prompt-param-modal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;align-items:center;justify-content:center;">
                <div style="background:#fff;padding:32px 40px;border-radius:10px;min-width:500px;max-width:90vw;max-height:80vh;overflow:auto;">
                    <h3>勾选用户输入参数 <span style="float:right;cursor:pointer;color:#888;" onclick="closePromptParams()">关闭</span></h3>
                    <div id="prompt-param-list"></div>
                    <div style="margin-top:16px;text-align:right;">
                        <button type="button" onclick="applyPromptParams()" style="background:#4f8cff;">应用到表单</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-btn-bar">
            <button type="submit">{{ submit_text }}</button>
            <a href="/admin/workflow">返回列表</a>
        </div>
    </div>
</form>
<script>
function showPromptParams() {
    var workflow = document.querySelector('textarea[name="workflow"]').value;
    fetch('/admin/workflow/prompt_params', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'workflow=' + encodeURIComponent(workflow)
    }).then(r=>r.json()).then(res=>{
        if(res.params){
            // 只做输入参数选择，类型可手动选择（IMG/STR/VIDEO），支持自定义别名（alias）
            let params = res.params.inputs || [];
            let html = '<div style="margin-bottom:16px;font-weight:bold;">勾选输入参数，可自定义别名(alias)和类型（IMG、STR、VIDEO）</div>';
            html += '<table style="width:100%;font-size:15px;"><tr><th>节点</th><th>类型</th><th>参数</th><th>路径</th><th>类型</th><th>别名(alias)</th><th>选择</th></tr>';
            for(let p of params){
                let type = (p.type||'').toUpperCase();
                if(['IMG','STR','VIDEO'].indexOf(type)===-1) type = 'STR';
                html += `<tr><td>${p.node_id}</td><td>${p.node_type}</td><td>${p.param}</td><td>${p.path}</td><td>`+
                    `<select class='input-type' data-path='${p.path}' data-name='${p.param}'>`+
                    `<option value='IMG' ${type==='IMG'?'selected':''}>IMG</option>`+
                    `<option value='STR' ${type==='STR'?'selected':''}>STR</option>`+
                    `<option value='VIDEO' ${type==='VIDEO'?'selected':''}>VIDEO</option>`+
                    `</select></td>`+
                    `<td><input class='input-alias' data-path='${p.path}' data-name='${p.param}' style='width:90px;' placeholder='可选'></td>`+
                    `<td><input type='checkbox' class='input-param' data-path='${p.path}' data-name='${p.param}'></td></tr>`;
            }
            html += '</table>';
            document.getElementById('prompt-param-list').innerHTML = html;
        }else{
            document.getElementById('prompt-param-list').innerHTML = '<div style="color:red;">解析失败：'+(res.error||'未知错误')+'</div>';
        }
        document.getElementById('prompt-param-modal').style.display = 'flex';
    });
}
function closePromptParams(){
    document.getElementById('prompt-param-modal').style.display = 'none';
}
function applyPromptParams(){
    // 只生成 input_schema，类型和别名(alias)由下拉框和输入框选择，name为参数名，alias为别名
    let inputs = [];
    document.querySelectorAll('.input-param:checked').forEach(cb=>{
        let path = cb.dataset.path;
        let name = cb.dataset.name;
        let typeSel = document.querySelector(`select.input-type[data-path='${path}'][data-name='${name}']`);
        let type = typeSel ? typeSel.value : 'STR';
        let aliasInput = document.querySelector(`input.input-alias[data-path='${path}'][data-name='${name}']`);
        let alias = aliasInput && aliasInput.value.trim() ? aliasInput.value.trim() : undefined;
        let item = {name: name, type: type, path: path};
        if(alias) item.alias = alias;
        inputs.push(item);
    });
    document.querySelector('textarea[name="input_schema"]').value = JSON.stringify({inputs:inputs});
    closePromptParams();
}
</script>
</body>
</html>
